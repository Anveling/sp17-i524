#!/usr/bin/env python
# -*- elpy-mode: nil; auto-complete-mode: nil; company-mode: nil -*-

from __future__ import print_function

from subprocess import check_call, CalledProcessError
from pipes import quote

import glob
import sys
import os.path

hid_dirs = sys.argv[1:]

class Verifier(object):

    def _call(self, cmd, **kwargs):
        """Wrapper around subprocess.check_call

        :param cmd: a list of strings that will be passed to check_call
        """

        pretty = ' '.join(map(quote, cmd))
        print('Running:', pretty)
        check_call(cmd, **kwargs)


    def make(self, path):
        """Checks that the 'make' command works for a submission"""
        print('Building', path)
        self._call(['make'], cwd=path)

    def readme_exists(self, path, readme_name='README.rst'):
        """Checks that the README.rst file exists for a submission"""
        readme = os.path.join(path, readme_name)
        print('Checking for', readme)
        if not os.path.exists(readme):
            raise ValueError('NOT FOUND: %s' % readme)


verify = Verifier()

for path in hid_dirs:
    try:
        verify.make(path)
        verify.readme_exists(path)
        print('OK')
    except CalledProcessError, e:
        print('FAIL')
        raise


    
